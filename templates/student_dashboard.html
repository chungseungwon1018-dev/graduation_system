<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ëŒ€ì‹œë³´ë“œ - ì¡¸ì—…í•™ì  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #2c3e50;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .notification-icon:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            min-width: 20px;
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: background 0.3s;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #ebf8ff;
            border-left: 4px solid #667eea;
        }

        .notification-item.urgent {
            border-left: 4px solid #e74c3c;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .notification-message {
            font-size: 0.9em;
            color: #7f8c8d;
            line-height: 1.4;
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 0.8em;
            color: #95a5a6;
        }

        .notification-empty {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .nav {
            background: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav ul {
            list-style: none;
            display: flex;
            gap: 30px;
        }

        .nav a {
            text-decoration: none;
            color: #2c3e50;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav a:hover, .nav a.active {
            background: #667eea;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            margin: 20px 0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area.dragover {
            border-color: #5a67d8;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card, .analysis-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .progress-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 15px;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        .progress-fill.completed {
            background: #2ecc71;
        }

        .progress-fill.warning {
            background: #f39c12;
        }

        .progress-fill.danger {
            background: #e74c3c;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .recommendations {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .recommendation-item {
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .recommendation-item.urgent {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-info {
            background: #ebf8ff;
            color: #2c5282;
            border: 1px solid #bee3f8;
        }

        .alert-success {
            background: #f0fff4;
            color: #2d7738;
            border: 1px solid #c6f6d5;
        }

        .alert-warning {
            background: #fffaf0;
            color: #c05621;
            border: 1px solid #fbd38d;
        }

        .alert-error {
            background: #fee;
            color: #c53030;
            border: 1px solid #fed7d7;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .hidden {
            display: none;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 600px;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        .profile-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .profile-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .profile-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            line-height: 1.6;
        }

        .profile-info p {
            margin: 8px 0;
        }

        .edit-btn {
            background: #f39c12;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .edit-btn:hover {
            background: #e67e22;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            
            .profile-info {
                grid-template-columns: 1fr;
            }
        }

        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: left;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav ul {
                flex-direction: column;
                gap: 10px;
            }
            
            .progress-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .progress-bar {
                width: 100%;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ“Š í•™ì  ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
            <div class="user-info">
                <span>{{ user.user_id }}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</span>
                <div class="notification-icon" onclick="toggleNotificationDropdown()">
                    <span style="font-size: 1.2em;">ğŸ””</span>
                    <div id="notificationBadge" class="notification-badge" style="display: none;">0</div>
                    
                    <div id="notificationDropdown" class="notification-dropdown">
                        <div class="notification-header">
                            <h4 style="margin: 0; color: #2c3e50;">ì•Œë¦¼</h4>
                            <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 0.9em;">ëª¨ë‘ ì½ìŒ</button>
                        </div>
                        <div id="notificationList">
                            <div class="notification-empty">
                                <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“­</div>
                                <div>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                            </div>
                        </div>
                        <div style="padding: 10px; text-align: center; border-top: 1px solid #eee;">
                            <a href="#" onclick="showAllNotifications()" style="color: #667eea; text-decoration: none; font-size: 0.9em;">ëª¨ë“  ì•Œë¦¼ ë³´ê¸°</a>
                        </div>
                    </div>
                </div>
                <a href="/logout" class="btn" style="padding: 8px 16px; font-size: 0.9em;">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-content">
            <ul>
                <li><a href="/student/dashboard" class="active">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="#" onclick="showStudentProfile()">ë‚´ ì •ë³´</a></li>
                <li><a href="#" onclick="showAllNotifications()">ì•Œë¦¼</a></li>
            </ul>
        </div>
    </nav>

    <!-- í•™ìƒ ì •ë³´ ëª¨ë‹¬ -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProfileModal()">&times;</span>
            <h2 style="color: #2c3e50; margin-bottom: 25px;">ğŸ‘¤ ë‚´ ì •ë³´</h2>
            
            <div class="profile-section">
                <h4>ğŸ“ ê¸°ë³¸ ì •ë³´</h4>
                <div class="profile-info" id="basicInfo">
                    <div class="loading">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <div class="profile-section">
                <h4>ğŸ“ í•™ì—… ì •ë³´</h4>
                <div class="profile-info" id="academicInfo">
                    <div class="loading">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <div class="profile-section">
                <h4>ğŸ“Š ìµœê·¼ ë¶„ì„ ê¸°ë¡</h4>
                <div id="recentAnalysis">
                    <div class="loading">ë¶„ì„ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button class="edit-btn" onclick="editProfile()">ì •ë³´ ìˆ˜ì •</button>
                <button class="btn" onclick="closeProfileModal()" style="margin-left: 10px;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="alertContainer"></div>

        <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="upload-section">
            <h2>ğŸ“„ ì„±ì í‘œ ì—…ë¡œë“œ</h2>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Excel íŒŒì¼(.xlsx)ì„ ì—…ë¡œë“œí•˜ì—¬ ì¡¸ì—…ìš”ê±´ ë¶„ì„ì„ ë°›ì•„ë³´ì„¸ìš”</p>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <p><strong>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</strong></p>
                <p style="color: #7f8c8d; font-size: 0.9em;">ì§€ì› í˜•ì‹: .xlsx (ìµœëŒ€ 10MB)</p>
            </div>
            
            <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
            <div id="fileInfo" class="file-info hidden"></div>
            
            <button id="uploadBtn" class="btn btn-success" style="margin-top: 15px;" disabled>
                ì—…ë¡œë“œ ë° ë¶„ì„ ì‹œì‘
            </button>
        </div>

        <!-- ë¶„ì„ í˜„í™© -->
        <div class="dashboard-grid">
            <div class="info-card">
                <h3 class="card-title">ğŸ“‹ ë‚´ ì •ë³´</h3>
                <div id="studentInfo">
                    <div class="loading">í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
            
            <div class="analysis-card">
                <h3 class="card-title">ğŸ“Š ë¶„ì„ í˜„í™©</h3>
                <div id="analysisStatus">
                    <div class="loading">ë¶„ì„ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</div>
                </div>
                <div id="parsingWarningsContainer"></div>
            </div>
        </div>




        <!-- ì§„í–‰ë¥  í‘œì‹œ -->
        <div class="progress-container">
            <h3 class="card-title">ğŸ¯ ì¡¸ì—…ìš”ê±´ ë‹¬ì„±ë¥ </h3>
            <div id="progressContainer">
                <div class="loading">ì§„í–‰ë¥  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ì°¨íŠ¸ -->
        <div class="chart-container">
            <h3 class="card-title">ğŸ“ˆ ìƒì„¸ ë¶„ì„ ì°¨íŠ¸</h3>
            <div id="chartContainer">
                <div class="loading">ì°¨íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ì¶”ì²œì‚¬í•­ -->
        <div class="recommendations">
            <h3 class="card-title">ğŸ’¡ ì¶”ì²œì‚¬í•­</h3>
            <div id="recommendationsContainer">
                <div class="loading">ì¶”ì²œì‚¬í•­ì„ ìƒì„±í•˜ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentAnalysis = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeUpload();
            loadStudentData();
            loadNotifications();
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ì•Œë¦¼ í™•ì¸ (5ë¶„ë§ˆë‹¤)
            setInterval(loadNotifications, 5 * 60 * 1000);
        });

        // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInfo = document.getElementById('fileInfo');

            // í´ë¦­ ì—…ë¡œë“œ
            uploadArea.addEventListener('click', () => fileInput.click());

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // íŒŒì¼ ì„ íƒ
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // ì—…ë¡œë“œ ë²„íŠ¼
            uploadBtn.addEventListener('click', uploadFile);
        }

        function handleFileSelect(file) {
            const fileInfo = document.getElementById('fileInfo');
            const uploadBtn = document.getElementById('uploadBtn');

            if (!file.name.endsWith('.xlsx')) {
                showAlert('Excel íŒŒì¼(.xlsx)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showAlert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            fileInfo.innerHTML = `
                <strong>ì„ íƒëœ íŒŒì¼:</strong> ${file.name}<br>
                <strong>í¬ê¸°:</strong> ${(file.size / 1024).toFixed(1)} KB<br>
                <strong>ìˆ˜ì •ì¼:</strong> ${new Date(file.lastModified).toLocaleString()}
            `;
            fileInfo.classList.remove('hidden');
            uploadBtn.disabled = false;
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!fileInput.files.length) {
                showAlert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            
            // ë¶„ì„ ì¤‘ ìƒíƒœë¡œ UI ì—…ë°ì´íŠ¸
            showAnalysisProgress();

            try {
                const response = await fetch('/api/student/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    
                    // ì—…ë¡œë“œ ì„±ê³µ í›„ íŒŒì¼ ì •ë³´ ì´ˆê¸°í™”
                    resetUploadForm();
                    
                    // ì ì‹œ ëŒ€ê¸° í›„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ì„œë²„ì—ì„œ ë¶„ì„ ì™„ë£Œ ëŒ€ê¸°)
                    setTimeout(async () => {
                        await loadStudentData();
                        hideAnalysisProgress();
                        showAlert('ë¶„ì„ ê²°ê³¼ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }, 1000);
                    
                } else {
                    showAlert(result.error || 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    hideAnalysisProgress();
                }
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                hideAnalysisProgress();
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ì—…ë¡œë“œ ë° ë¶„ì„ ì‹œì‘';
            }
        }

        function resetUploadForm() {
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const uploadBtn = document.getElementById('uploadBtn');
            
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            uploadBtn.disabled = true;
        }

        function showAnalysisProgress() {
            document.getElementById('analysisStatus').innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 2em; margin-bottom: 15px;">â³</div>
                    <div style="font-weight: bold; margin-bottom: 10px;">ë¶„ì„ ì§„í–‰ ì¤‘...</div>
                    <div style="color: #7f8c8d;">íŒŒì¼ì„ ë¶„ì„í•˜ê³  ì¡¸ì—…ìš”ê±´ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.</div>
                </div>
            `;
            
            document.getElementById('progressContainer').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #7f8c8d;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">ğŸ“Š</div>
                    <div>ì¡¸ì—…ìš”ê±´ ë¶„ì„ ì¤‘...</div>
                </div>
            `;
            
            document.getElementById('chartContainer').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #7f8c8d;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">ğŸ“ˆ</div>
                    <div>ì°¨íŠ¸ ìƒì„± ì¤‘...</div>
                </div>
            `;
            
            document.getElementById('recommendationsContainer').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #7f8c8d;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">ğŸ’¡</div>
                    <div>ì¶”ì²œì‚¬í•­ ìƒì„± ì¤‘...</div>
                </div>
            `;
        }

        function hideAnalysisProgress() {
            // ì§„í–‰ë¥  í‘œì‹œë¥¼ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜ (í•„ìš”ì‹œ ì‚¬ìš©)
        }

        async function loadStudentData() {
            try {
                // í•™ìƒ ì •ë³´ ë¡œë“œ
                const infoResponse = await fetch('/api/student/info');
                const infoData = await infoResponse.json();

                if (infoData.success) {
                    displayStudentInfo(infoData.student);
                } else {
                    console.warn('í•™ìƒ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', infoData);
                }

                // ë¶„ì„ ê²°ê³¼ ë¡œë“œ (ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€)
                const timestamp = new Date().getTime();
                const analysisResponse = await fetch(`/api/student/analysis?t=${timestamp}`);
                const analysisData = await analysisResponse.json();

                console.log('ë¶„ì„ ë°ì´í„° ì‘ë‹µ:', analysisData); // ë””ë²„ê¹…ìš©

                if (analysisData.success && analysisData.analysis) {
                    currentAnalysis = analysisData.analysis;
                    console.log('ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì‹œì‘:', analysisData.analysis); // ë””ë²„ê¹…ìš©
                    displayAnalysisResults(analysisData.analysis);
                } else {
                    console.log('ë¶„ì„ ë°ì´í„° ì—†ìŒ, ê¸°ë³¸ í™”ë©´ í‘œì‹œ'); // ë””ë²„ê¹…ìš©
                    displayNoAnalysis();
                }
            } catch (error) {
                console.error('Data loading error:', error);
                showAlert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                displayNoAnalysis();
            }
        }

        function displayStudentInfo(student) {
            const container = document.getElementById('studentInfo');
            container.innerHTML = `
                <div style="line-height: 1.6;">
                    <p><strong>í•™ë²ˆ:</strong> ${student.student_id || '-'}</p>
                    <p><strong>ì´ë¦„:</strong> ${student.name || '-'}</p>
                    <p><strong>í•™ê³¼:</strong> ${student.department || '-'}</p>
                    <p><strong>í•™ë…„:</strong> ${student.grade || '-'}í•™ë…„</p>
                    <p><strong>ì „ê³µ:</strong> ${student.major || '-'}</p>
                </div>
            `;
        }

        function displayAnalysisResults(analysis) {
            console.log('ë¶„ì„ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ ì‹¤í–‰:', analysis); // ë””ë²„ê¹…ìš©
            
            try {
                displayAnalysisStatus(analysis);
                console.log('ë¶„ì„ ìƒíƒœ í‘œì‹œ ì™„ë£Œ'); // ë””ë²„ê¹…ìš©



                displayParsingWarnings(analysis);
                displayProgress(analysis);
                console.log('ì§„í–‰ë¥  í‘œì‹œ ì™„ë£Œ'); // ë””ë²„ê¹…ìš©

                displayChart(analysis);
                console.log('ì°¨íŠ¸ í‘œì‹œ ì™„ë£Œ'); // ë””ë²„ê¹…ìš©

                displayRecommendations(analysis);
                console.log('ì¶”ì²œì‚¬í•­ í‘œì‹œ ì™„ë£Œ'); // ë””ë²„ê¹…ìš©

            } catch (error) {
                console.error('ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', error);
                showAlert('ë¶„ì„ ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // íŒŒì‹± ê²½ê³  í‘œì‹œ (í”„ë¡ íŠ¸ì— ë¶„ëª…íˆ ë…¸ì¶œ)
        function displayParsingWarnings(analysis) {
            const warnings = analysis.parsing_warnings || [];
            const container = document.getElementById('parsingWarningsContainer');
            if (!container) return;
            if (warnings.length === 0) {
                container.innerHTML = '';
                return;
            }
            let html = `<div style="background:#fff3cd;border:1px solid #ffeeba;padding:10px;border-radius:6px;margin-bottom:10px;color:#856404;">
                <strong>íŒŒì¼ íŒŒì‹± ê²½ê³ :</strong>
                <ul style="margin:6px 0 0 18px;">`;
            for (const w of warnings) {
                html += `<li>${w}</li>`;
            }
            html += `</ul></div>`;
            container.innerHTML = html;
        }

        // êµì–‘ ìƒì„¸(OCU/ê¸°íƒ€ ë“±) í…Œì´ë¸” í‘œì‹œ í•¨ìˆ˜
        function displayLiberalArtsDetail(analysis) {
            const detail = analysis.liberal_arts_detail || {};
            const cap = analysis.liberal_arts_cap;
            const overflow = analysis.liberal_arts_overflow;
            const container = document.getElementById('liberalArtsDetailContainer');
            if (!container) return;
            let html = `<div style="margin:18px 0 24px 0;">
                <h4 style="color:#764ba2; margin-bottom:10px;">êµì–‘ ì„¸ë¶€ ì´ìˆ˜ë‚´ì—­ (OCU/ê¸°íƒ€ í¬í•¨)</h4>
                <table style="width:100%; border-collapse:collapse; background:#fafbfc;">
                <thead><tr style="background:#f0f0fa;"><th style="padding:6px 8px;">ì˜ì—­</th><th style="padding:6px 8px;">ì´ìˆ˜í•™ì </th></tr></thead><tbody>`;
            let hasDetail = false;
            for (const [area, credits] of Object.entries(detail)) {
                html += `<tr><td style="padding:6px 8px;">${area}</td><td style="padding:6px 8px;">${credits}í•™ì </td></tr>`;
                hasDetail = true;
            }
            html += `</tbody></table>`;
            html += `<div style="margin-top:8px; color:#7f8c8d; font-size:0.95em;">* êµì–‘ ìƒí•œ: ${cap}í•™ì , ì´ˆê³¼ë¶„: ${overflow}í•™ì </div>`;
            html += `</div>`;
            container.innerHTML = hasDetail ? html : '<div style="color:#7f8c8d; margin:12px 0;">êµì–‘ ì„¸ë¶€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        function displayAnalysisStatus(analysis) {
            const container = document.getElementById('analysisStatus');
            const analysisDate = new Date(analysis.analysis_date).toLocaleString();
            const remainingCredits = analysis.total_required_credits - analysis.total_completed_credits;
            const progressColor = analysis.overall_completion_rate >= 90 ? '#27ae60' : 
                                 analysis.overall_completion_rate >= 70 ? '#2ecc71' :
                                 analysis.overall_completion_rate >= 50 ? '#f39c12' : '#e74c3c';
            
            container.innerHTML = `
                <div style="line-height: 1.8;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span><strong>ë¶„ì„ì¼ì‹œ:</strong></span>
                        <span style="color: #7f8c8d; font-size: 0.9em;">${analysisDate}</span>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 2.5em; font-weight: bold; color: ${progressColor}; margin-bottom: 5px;">
                            ${analysis.overall_completion_rate}%
                        </div>
                        <div style="color: #7f8c8d; font-size: 0.9em;">ì „ì²´ ì´ìˆ˜ìœ¨</div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>ì´ìˆ˜í•™ì </span>
                            <span style="font-weight: bold; color: #27ae60;">${analysis.total_completed_credits}í•™ì </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>í•„ìš”í•™ì </span>
                            <span style="font-weight: bold;">${analysis.total_required_credits}í•™ì </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px;">
                            <span style="color: ${remainingCredits <= 0 ? '#27ae60' : '#e74c3c'};">
                                ${remainingCredits <= 0 ? 'ì¡¸ì—… ìš”ê±´ ì¶©ì¡±' : 'ë¶€ì¡±í•™ì '}
                            </span>
                            <span style="font-weight: bold; color: ${remainingCredits <= 0 ? '#27ae60' : '#e74c3c'};">
                                ${remainingCredits <= 0 ? 'ì™„ë£Œ!' : `${remainingCredits}í•™ì `}
                            </span>
                        </div>
                    </div>
                </div>
            `;

            // ê°œì‹ ê¸°ì´ˆêµì–‘ ì²´í¬ë¦¬ìŠ¤íŠ¸ëŠ” ì§„í–‰ë¥  ì„¹ì…˜ì—ì„œ ë°°ì¹˜í•©ë‹ˆë‹¤.
        }

        function displayProgress(analysis) {
            // êµì–‘ ìƒì„¸ í…Œì´ë¸” ì•„ë˜ì— í‘œì‹œë  ìˆ˜ ìˆë„ë¡ ìœ„ì¹˜ ì¡°ì •
            // (liberalArtsDetailContainerëŠ” displayAnalysisResultsì—ì„œ ë¨¼ì € ì±„ì›Œì§)
            const container = document.getElementById('progressContainer');
            const requirements = analysis.requirements_analysis || [];
            
            if (requirements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let progressHtml = '';
            
            // ì˜ì—­ëª… ì •ê·œí™” í•¨ìˆ˜ (ì ‘ë¯¸ì‚¬ ì œê±°)
            const normalizeArea = (area) => {
                if (!area) return '';
                // '(ì´í•©)' ë“± ì ‘ë¯¸ì‚¬ ì œê±°
                return String(area).replace(/\s*\(ì´í•©\)\s*$/,'');
            };
            
            // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™” (ì´êµì–‘í•™ì , ì´í•™ì , ê°œì‹ ê¸°ì´ˆêµì–‘(ì´í•©) ì œì™¸)
            const groupedRequirements = {};
            requirements.forEach(req => {
                // ì´êµì–‘í•™ì , ì´í•™ì , ê°œì‹ ê¸°ì´ˆêµì–‘(ì´í•©)ì€ ì œì™¸ (ì¹©ìœ¼ë¡œë§Œ í‘œì‹œ)
                if (req.area === 'ì´êµì–‘í•™ì ' || req.area === 'ì´í•™ì ' || normalizeArea(req.area) === 'ê°œì‹ ê¸°ì´ˆêµì–‘') {
                    return;
                }
                const category = req.category;
                if (!groupedRequirements[category]) {
                    groupedRequirements[category] = [];
                }
                groupedRequirements[category].push(req);
            });
            
            // êµì–‘ ì˜ì—­ ì •ë ¬ ìˆœì„œ ì •ì˜
            const liberalArtsOrder = ['ê°œì‹ ê¸°ì´ˆêµì–‘', 'ì¼ë°˜êµì–‘', 'í™•ëŒ€êµì–‘', 'OCUê¸°íƒ€'];
            
            // ì „ê³µ ì˜ì—­ ì •ë ¬ ìˆœì„œ ì •ì˜
            const majorOrder = ['ì „ê³µí•„ìˆ˜', 'ì „ê³µì„ íƒ'];
            
            // ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ í‘œì‹œ
            Object.keys(groupedRequirements).forEach(category => {
                let categoryReqs = groupedRequirements[category];
                
                // êµì–‘ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° ìˆœì„œëŒ€ë¡œ ì •ë ¬
                if (category === 'êµì–‘') {
                    categoryReqs = categoryReqs.sort((a, b) => {
                        const indexA = liberalArtsOrder.indexOf(normalizeArea(a.area));
                        const indexB = liberalArtsOrder.indexOf(normalizeArea(b.area));
                        // ìˆœì„œì— ì—†ëŠ” í•­ëª©ì€ ë’¤ë¡œ
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                }
                // ì „ê³µ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ì „ê³µí•„ìˆ˜ -> ì „ê³µì„ íƒ)
                else if (category === 'ì „ê³µ') {
                    categoryReqs = categoryReqs.sort((a, b) => {
                        const indexA = majorOrder.indexOf(a.area);
                        const indexB = majorOrder.indexOf(b.area);
                        // ìˆœì„œì— ì—†ëŠ” í•­ëª©ì€ ë’¤ë¡œ
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                }
                const categoryEmoji = getCategoryEmoji(category);
                
                progressHtml += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #667eea;">
                            ${categoryEmoji} ${category}
                        </h4>
                `;

                // êµì–‘ ì¹´í…Œê³ ë¦¬ ìƒë‹¨ì— ê°œì‹ ê¸°ì´ˆêµì–‘ ì¹© 4ê°œë§Œ ë°°ì¹˜ (ì´í•© ì¹´ë“œëŠ” ì œì™¸)
                if (category === 'êµì–‘') {
                    const detail = analysis.gsin_basic_detail || null;
                    if (detail && Object.keys(detail).length > 0) {
                        const fmtInt = (n) => {
                            const v = parseFloat(n || 0);
                            return Math.round(v);
                        };
                        const partsOrder = [
                            'ì¸ì„±ê³¼ ë¹„íŒì  ì‚¬ê³ ',
                            'ì˜ì‚¬ì†Œí†µ',
                            'ì˜ì–´',
                            'ì •ë³´ë¬¸í•´'
                        ];
                        const partLabels = {
                            'ì¸ì„±ê³¼ ë¹„íŒì  ì‚¬ê³ ': 'ì¸ì„±ê³¼ ë¹„íŒì  ì‚¬ê³ ',
                            'ì˜ì‚¬ì†Œí†µ': 'ì˜ì‚¬ì†Œí†µ',
                            'ì˜ì–´': 'ì˜ì–´',
                            'ì •ë³´ë¬¸í•´': 'ì •ë³´ë¬¸í•´'
                        };
                        progressHtml += `
                            <div style="background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin-bottom:12px;">
                                <div style="font-weight:bold;color:#111827;margin-bottom:10px;">ğŸ“š ê°œì‹ ê¸°ì´ˆêµì–‘</div>
                                <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        `;
                        partsOrder.forEach(p => {
                            const part = detail[p] || { completed_credits: 0, required_credits: 3 };
                            const comp = fmtInt(part.completed_credits);
                            const req = fmtInt(part.required_credits);
                            const done = comp >= req;
                            const bg = done ? '#dcfce7' : '#fee2e2';
                            const border = done ? '#86efac' : '#fecaca';
                            const text = done ? '#166534' : '#7f1d1d';
                            progressHtml += `
                                <span style="background:${bg};color:${text};border:1px solid ${border};padding:6px 10px;border-radius:16px;font-size:0.95em;display:inline-flex;align-items:center;gap:6px;">
                                    <span>${partLabels[p]}</span>
                                    <strong>${comp}/${req}</strong>
                                </span>
                            `;
                        });
                        progressHtml += `
                                </div>
                            </div>
                        `;
                    }
                }
                
                categoryReqs.forEach(req => {
                    const percentage = Math.min(100, req.completion_rate);
                    const isComplete = percentage >= 100;
                    const statusColor = isComplete ? '#27ae60' : 
                                       percentage >= 70 ? '#f39c12' : '#e74c3c';
                    const statusIcon = isComplete ? 'âœ…' : 
                                      percentage >= 70 ? 'âš ï¸' : 'âŒ';
                    
                    progressHtml += `
                        <div class="progress-item" style="background: ${isComplete ? '#f0fff4' : '#fefefe'}; border-left: 4px solid ${statusColor}; margin-bottom: 10px; padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #2c3e50;">
                                        ${statusIcon} ${req.area || 'ê¸°ë³¸ ì˜ì—­'}
                                    </div>
                                    <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;">
                                        ${req.completed_credits}í•™ì  / ${req.required_credits}í•™ì  ì´ìˆ˜
                                        ${req.missing_credits > 0 ? `(${req.missing_credits}í•™ì  ë¶€ì¡±)` : ''}
                                    </div>
                                </div>
                                <div style="text-align: right; min-width: 80px;">
                                    <div style="font-size: 1.2em; font-weight: bold; color: ${statusColor};">
                                        ${percentage.toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                            <div class="progress-bar" style="width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden;">
                                <div style="height: 100%; background: ${statusColor}; width: ${percentage}%; transition: width 0.5s ease; border-radius: 6px;"></div>
                            </div>
                        </div>
                    `;
                });
                
                progressHtml += '</div>';
            });

            container.innerHTML = progressHtml;
        }
        
        function getCategoryEmoji(category) {
            const emojiMap = {
                'êµì–‘': 'ğŸ“š',
                'ì „ê³µ': 'ğŸ“',
                'ê¸°íƒ€': 'ğŸ“‹',
                'ì¼ë°˜': 'ğŸ“'
            };
            return emojiMap[category] || 'ğŸ“–';
        }

        function displayChart(analysis) {
            const container = document.getElementById('chartContainer');
            // requirements_analysisì— ì´ë¯¸ êµì–‘ í•˜ìœ„ì˜ì—­(OCU/ê¸°íƒ€ ë“±)ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
            const requirements = analysis.requirements_analysis || [];
            
            if (requirements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">ë¶„ì„ í›„ ì°¨íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // íƒ­ ë„¤ë¹„ê²Œì´ì…˜ê³¼ ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±
            container.innerHTML = `
                <div class="chart-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee;">
                    <button class="chart-tab active" onclick="showChart('completion')" style="flex: 1; padding: 12px; border: none; background: #667eea; color: white; cursor: pointer; border-radius: 5px 5px 0 0;">
                        ğŸ“Š ì´ìˆ˜ìœ¨ í˜„í™©
                    </button>
                    <button class="chart-tab" onclick="showChart('credits')" style="flex: 1; padding: 12px; border: none; background: #f8f9fa; color: #2c3e50; cursor: pointer; border-radius: 5px 5px 0 0; margin-left: 2px;">
                        ğŸ“ˆ í•™ì  í˜„í™©
                    </button>
                    <button class="chart-tab" onclick="showChart('donut')" style="flex: 1; padding: 12px; border: none; background: #f8f9fa; color: #2c3e50; cursor: pointer; border-radius: 5px 5px 0 0; margin-left: 2px;">
                        ğŸ© ì „ì²´ ë¹„ìœ¨
                    </button>
                </div>
                <div style="height: 400px; position: relative;">
                    <canvas id="analysisChart" style="max-height: 100%;"></canvas>
                </div>
            `;

            currentChart = null;
            currentAnalysisData = analysis;
            
            // ê¸°ë³¸ì ìœ¼ë¡œ ì´ìˆ˜ìœ¨ ì°¨íŠ¸ í‘œì‹œ
            showChart('completion');
        }

        let currentChart = null;
        let currentAnalysisData = null;

        function showChart(type, evt = null) {
            if (!currentAnalysisData) return;
            
            // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.style.background = '#f8f9fa';
                tab.style.color = '#2c3e50';
                tab.classList.remove('active');
            });
            // ì´ë²¤íŠ¸ ê¸°ë°˜ í˜¸ì¶œì´ë©´ í•´ë‹¹ íƒ­ í™œì„±í™”, ì•„ë‹ˆë©´ íƒ€ì…ì— ë§ëŠ” íƒ­ì„ í™œì„±í™”
            if (evt && evt.target) {
                evt.target.style.background = '#667eea';
                evt.target.style.color = 'white';
                evt.target.classList.add('active');
            } else {
                const tabs = document.querySelectorAll('.chart-tab');
                // typeì— ë”°ë¼ ì¸ë±ìŠ¤ ì„ íƒ: completion=0, credits=1, donut=2
                const typeIndexMap = { completion: 0, credits: 1, donut: 2 };
                const idx = typeIndexMap[type] ?? 0;
                const tab = tabs[idx];
                if (tab) {
                    tab.style.background = '#667eea';
                    tab.style.color = 'white';
                    tab.classList.add('active');
                }
            }

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = document.getElementById('analysisChart').getContext('2d');
            const requirements = currentAnalysisData.requirements_analysis || [];

            if (type === 'completion') {
                // ì´ìˆ˜ìœ¨ ë§‰ëŒ€ ì°¨íŠ¸
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: requirements.map(req => `${req.category}\n${req.area || ''}`),
                        datasets: [{
                            label: 'ì´ìˆ˜ìœ¨ (%)',
                            data: requirements.map(req => req.completion_rate),
                            backgroundColor: requirements.map(req => 
                                req.completion_rate >= 100 ? '#27ae60' :
                                req.completion_rate >= 70 ? '#f39c12' : '#e74c3c'
                            ),
                            borderColor: requirements.map(req => 
                                req.completion_rate >= 100 ? '#229954' :
                                req.completion_rate >= 70 ? '#d68910' : '#c0392b'
                            ),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ì˜ì—­ë³„ ì¡¸ì—…ìš”ê±´ ì´ìˆ˜ìœ¨',
                                font: { size: 16 }
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 120,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
            } else if (type === 'credits') {
                // í•™ì  í˜„í™© ì°¨íŠ¸
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: requirements.map(req => `${req.category}\n${req.area || ''}`),
                        datasets: [
                            {
                                label: 'ì´ìˆ˜í•™ì ',
                                data: requirements.map(req => req.completed_credits),
                                backgroundColor: '#3498db',
                                borderColor: '#2980b9',
                                borderWidth: 2
                            },
                            {
                                label: 'í•„ìš”í•™ì ',
                                data: requirements.map(req => req.required_credits),
                                backgroundColor: '#ecf0f1',
                                borderColor: '#95a5a6',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ì˜ì—­ë³„ í•™ì  ì´ìˆ˜ í˜„í™©',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + 'í•™ì ';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
            } else if (type === 'donut') {
                // ì „ì²´ ë¹„ìœ¨ ë„ë„› ì°¨íŠ¸
                const totalCompleted = currentAnalysisData.total_completed_credits;
                const totalRequired = currentAnalysisData.total_required_credits;
                const remaining = Math.max(0, totalRequired - totalCompleted);
                
                currentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ì´ìˆ˜ì™„ë£Œ', 'ë¯¸ì´ìˆ˜'],
                        datasets: [{
                            data: [totalCompleted, remaining],
                            backgroundColor: ['#27ae60', '#ecf0f1'],
                            borderColor: ['#229954', '#bdc3c7'],
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ì „ì²´ í•™ì  ì´ìˆ˜ í˜„í™©',
                                font: { size: 16 }
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function displayRecommendations(analysis) {
            const container = document.getElementById('recommendationsContainer');
            const recommendations = analysis.recommendations || [];
            const missingRequirements = analysis.missing_requirements || [];
            
            // ê°œì‹ ê¸°ì´ˆêµì–‘ ë¶€ì¡± ì—¬ë¶€ í™•ì¸
            const gsinDetail = analysis.gsin_basic_detail || {};
            const hasGsinMissing = Object.values(gsinDetail).some(part => 
                part.completed_credits < part.required_credits
            );
            
            if (recommendations.length === 0 && missingRequirements.length === 0 && !hasGsinMissing) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ğŸ‰</div>
                        <h3 style="margin-bottom: 10px;">ì¶•í•˜í•©ë‹ˆë‹¤!</h3>
                        <p style="font-size: 1.1em; opacity: 0.9;">ëª¨ë“  ì¡¸ì—… ìš”ê±´ì„ ì¶©ì¡±í•˜ì˜€ìŠµë‹ˆë‹¤!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            // ë¶€ì¡± í•™ì  í‘œê¸°ëŠ” ì •ìˆ˜ë¡œ í‘œì‹œ
            const fmtCredits = (num) => {
                const n = parseFloat(num || 0);
                return Math.round(n);
            };
            
            // ê¸´ê¸‰ë„ë³„ ë¶„ë¥˜
            const urgentRecommendations = [];
            const normalRecommendations = [];
            
            recommendations.forEach(rec => {
                if (rec.includes('ë¶€ì¡±') || rec.includes('ë¯¸ì¶©ì¡±') || rec.includes('í•„ìš”')) {
                    urgentRecommendations.push(rec);
                } else {
                    normalRecommendations.push(rec);
                }
            });
            
            // ê°œì‹ ê¸°ì´ˆêµì–‘ ë¶€ì¡±í•œ íŒŒíŠ¸ í™•ì¸ (ìœ„ì—ì„œ ì´ë¯¸ ì„ ì–¸ëœ gsinDetail ì‚¬ìš©)
            const missingGsinParts = [];
            const partsOrder = ['ì¸ì„±ê³¼ ë¹„íŒì  ì‚¬ê³ ', 'ì˜ì‚¬ì†Œí†µ', 'ì˜ì–´', 'ì •ë³´ë¬¸í•´'];
            partsOrder.forEach(part => {
                const partData = gsinDetail[part];
                if (partData && partData.completed_credits < partData.required_credits) {
                    missingGsinParts.push({
                        part: part,
                        completed: partData.completed_credits,
                        required: partData.required_credits,
                        missing: partData.missing_credits
                    });
                }
            });
            
            // ê°œì‹ ê¸°ì´ˆêµì–‘ ë¶€ì¡±í•œ íŒŒíŠ¸ í‘œì‹œ
            if (missingGsinParts.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #e74c3c; margin-bottom: 15px; display: flex; align-items: center;">
                            <span style="font-size: 1.2em; margin-right: 8px;">ğŸ“š</span>
                            ê°œì‹ ê¸°ì´ˆêµì–‘ ë¯¸ì´ìˆ˜ íŒŒíŠ¸ (${missingGsinParts.length}ê°œ)
                        </h4>
                `;
                
                missingGsinParts.forEach(part => {
                    const completionRate = (part.completed / part.required) * 100;
                    const isLowCompletion = completionRate < 50;
                    const bgColor = isLowCompletion ? '#fdf2f2' : '#fef9e7';
                    const borderColor = isLowCompletion ? '#e74c3c' : '#f39c12';
                    const badgeColor = isLowCompletion ? '#e74c3c' : '#f39c12';
                    const icon = isLowCompletion ? 'ğŸš¨' : 'ğŸ’¡';
                    
                    html += `
                        <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 15px; margin-bottom: 12px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #2c3e50;">
                                    ${icon} ${part.part}
                                </div>
                                <div style="background: ${badgeColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em; font-weight: bold;">
                                    ${fmtCredits(part.missing)}í•™ì  ë¶€ì¡±
                                </div>
                            </div>
                            <div style="color: #7f8c8d; font-size: 0.9em;">
                                í˜„ì¬ ${fmtCredits(part.completed)}í•™ì  / í•„ìš” ${fmtCredits(part.required)}í•™ì 
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // ë¶€ì¡±í•œ ì˜ì—­ë³„ ìƒì„¸ ì •ë³´
            if (missingRequirements.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #e74c3c; margin-bottom: 15px; display: flex; align-items: center;">
                            <span style="font-size: 1.2em; margin-right: 8px;">âš ï¸</span>
                            ë¶€ì¡±í•œ ì˜ì—­ (${missingRequirements.length}ê°œ)
                        </h4>
                `;
                
                missingRequirements.forEach(req => {
                    const completionRate = req.required_credits > 0 ? (req.completed_credits / req.required_credits) * 100 : 0;
                    const isLowCompletion = completionRate < 50;
                    const urgencyColor = isLowCompletion ? '#e74c3c' : '#f39c12';
                    const urgencyIcon = isLowCompletion ? 'ğŸš¨' : 'âš ï¸';
                    const urgencyBg = isLowCompletion ? '#fdf2f2' : '#fef9e7';
                    
                    html += `
                        <div style="background: ${urgencyBg}; 
                                    border-left: 4px solid ${urgencyColor}; 
                                    padding: 15px; margin-bottom: 12px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #2c3e50;">
                                    ${urgencyIcon} ${req.category} ${req.area ? `- ${req.area}` : ''}
                                </div>
                                <div style="background: ${urgencyColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em; font-weight: bold;">
                                    ${fmtCredits(req.missing_credits)}í•™ì  ë¶€ì¡±
                                </div>
                            </div>
                            <div style="color: #7f8c8d; font-size: 0.9em;">
                                í˜„ì¬ ${fmtCredits(req.completed_credits)}í•™ì  / í•„ìš” ${fmtCredits(req.required_credits)}í•™ì 
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // ì¶”ì²œ í–‰ë™ì‚¬í•­: ì „í•„/ì „ì„  êµ¬ë¶„í•˜ì—¬ ì¹´ë“œ+ì¹©ìœ¼ë¡œ í‘œì‹œ
            const parseCourses = (rec) => {
                const idx = rec.indexOf('â†’');
                if (idx === -1) return [];
                const list = rec.substring(idx + 1).trim();
                return list.split(',').map(s => s.trim()).filter(Boolean);
            };

            const renderCourseChips = (courses) => {
                if (!courses || courses.length === 0) return '';
                const circledDigits = { '0':'â“ª','1':'â‘ ','2':'â‘¡','3':'â‘¢','4':'â‘£','5':'â‘¤','6':'â‘¥','7':'â‘¦','8':'â‘§','9':'â‘¨' };
                const toCircled = (n) => String(n).split('').map(d => circledDigits[d] || d).join('');
                return `
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">
                        ${courses.map(c => `
                            <span style="background:#eef2ff;color:#1f2937;border:1px solid #c7d2fe;padding:6px 10px;border-radius:16px;font-size:0.95em;">
                                ${(() => {
                                    // í˜•ì‹: "1í•™ë…„|íšŒê³„ì›ë¦¬" â†’ "â‘ íšŒê³„ì›ë¦¬"
                                    const parts = c.split('|');
                                    if (parts.length === 2) {
                                        const gradeMatch = parts[0].match(/(\d+)í•™ë…„/);
                                        const grade = gradeMatch ? gradeMatch[1] : '';
                                        const courseName = parts[1].replace(/\([^)]*\)/g, '').trim();
                                        return (grade ? toCircled(grade) : '') + courseName;
                                    }
                                    // êµ¬ë¶„ìê°€ ì—†ìœ¼ë©´ ê´„í˜¸ë§Œ ì œê±°
                                    return c.replace(/\([^)]*\)/g, '').trim();
                                })()}
                            </span>
                        `).join('')}
                    </div>
                `;
            };

            const requiredRec = recommendations.find(r => r.startsWith('ì „ê³µí•„ìˆ˜'));
            const electiveRec = recommendations.find(r => r.startsWith('ì „ê³µì„ íƒ'));

            if (requiredRec) {
                const mr = missingRequirements.find(r => r.category === 'ì „ê³µ' && r.area === 'ì „ê³µí•„ìˆ˜');
                const courses = parseCourses(requiredRec);
                html += `
                    <div style="margin-bottom:20px; background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:16px;">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:bold; color:#111827;">ğŸ“ ì „ê³µí•„ìˆ˜</div>
                            <div style="background:#fde68a;color:#7c2d12;padding:4px 10px;border-radius:12px;font-size:0.85em;">
                                ë¶€ì¡± ${fmtCredits(mr?.missing_credits || 0)}í•™ì 
                            </div>
                        </div>
                        ${renderCourseChips(courses)}
                    </div>
                `;
            }

            if (electiveRec) {
                const mr2 = missingRequirements.find(r => r.category === 'ì „ê³µ' && r.area === 'ì „ê³µì„ íƒ');
                const courses2 = parseCourses(electiveRec);
                html += `
                    <div style="margin-bottom:20px; background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:16px;">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:bold; color:#111827;">ğŸ“ ì „ê³µì„ íƒ</div>
                            <div style="background:#dbeafe;color:#1e40af;padding:4px 10px;border-radius:12px;font-size:0.85em;">
                                ë¶€ì¡± ${fmtCredits(mr2?.missing_credits || 0)}í•™ì 
                            </div>
                        </div>
                        ${renderCourseChips(courses2)}
                    </div>
                `;
            }

            // ê¸°íƒ€ ë¬¸ì¥í˜• ì¶”ì²œ(ì´ ë¶€ì¡± í•™ì  ë“±)ì€ ê°„ë‹¨ ë°°ì§€ë¡œ í‘œì‹œ
            const misc = recommendations.filter(r => !r.startsWith('ì „ê³µí•„ìˆ˜') && !r.startsWith('ì „ê³µì„ íƒ'));
            if (misc.length > 0) {
                html += `
                    <div style="background:#f8fafc;border:1px dashed #cbd5e1;border-radius:10px;padding:12px;">
                        ${misc.map(m => `<div style="color:#334155; font-size:0.95em;">${m.replace(/(\d+\.\d+)í•™ì /g, (m,g1)=>`${fmtCredits(g1)}í•™ì `)}</div>`).join('')}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function displayNoAnalysis() {
            document.getElementById('analysisStatus').innerHTML = '<p>ì•„ì§ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>Excel íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>';
            document.getElementById('progressContainer').innerHTML = '<p>ë¶„ì„ í›„ ì§„í–‰ë¥ ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
            document.getElementById('chartContainer').innerHTML = '<p>ë¶„ì„ í›„ ì°¨íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
            document.getElementById('recommendationsContainer').innerHTML = '<p>ë¶„ì„ í›„ ì¶”ì²œì‚¬í•­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // í•™ìƒ í”„ë¡œí•„ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function showStudentProfile() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'block';
            
            // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeProfileModal();
                }
            };
            
            // í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
            await loadProfileData();
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        async function loadProfileData() {
            try {
                const response = await fetch('/api/student/profile');
                const data = await response.json();
                
                if (data.success) {
                    displayProfileData(data.profile);
                } else {
                    showAlert('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('Profile loading error:', error);
                showAlert('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function displayProfileData(profile) {
            const basicInfo = profile.basic_info;
            const recentAnalyses = profile.recent_analyses;
            const uploadInfo = profile.upload_info;

                // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
            document.getElementById('basicInfo').innerHTML = `
                <div>
                    <p><strong>í•™ë²ˆ:</strong> ${basicInfo.student_id || '-'}</p>
                    <p><strong>ì„±ëª…:</strong> ${basicInfo.name || '-'}</p>
                    <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${basicInfo.phone || 'ì •ë³´ ì—†ìŒ'}</p>
                    <p><strong>ì´ë©”ì¼:</strong> ${basicInfo.email || 'ì •ë³´ ì—†ìŒ'}</p>
                </div>
                <div>
                    <p><strong>ìƒë…„ì›”ì¼:</strong> ${basicInfo.birth_date ? new Date(basicInfo.birth_date).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\s/g, '').replace(/\./g, '. ') : 'ì •ë³´ ì—†ìŒ'}</p>
                    <p><strong>êµê³¼ì ìš©ë…„ë„:</strong> ${basicInfo.curriculum_year || 'ì •ë³´ ì—†ìŒ'}</p>
                    <p><strong>ì´ìˆ˜í•™ê¸°:</strong> ${basicInfo.semester || 'ì •ë³´ ì—†ìŒ'}</p>
                    <p><strong>í•™ì ìƒíƒœ:</strong> ${basicInfo.status || 'ì •ë³´ ì—†ìŒ'}</p>
                </div>
            `;

            // í•™ì—… ì •ë³´ í‘œì‹œ
            document.getElementById('academicInfo').innerHTML = `
                <div>
                    <p><strong>ëŒ€í•™:</strong> ${basicInfo.university || '-'}</p>
                    <p><strong>í•™ê³¼:</strong> ${basicInfo.department || '-'}</p>
                    <p><strong>í•™ë…„:</strong> ${basicInfo.grade || '-'}í•™ë…„</p>
                </div>
                <div>
                    <p><strong>ê³¼ì •:</strong> ${basicInfo.course_type || '-'}</p>
                    <p><strong>ë¶€ì „ê³µ:</strong> ${basicInfo.minor || 'ì—†ìŒ'}</p>
                    <p><strong>ë‹¤ì „ê³µ:</strong> ${basicInfo.double_major || 'ì—†ìŒ'}</p>
                </div>
            `;            // ìµœê·¼ ë¶„ì„ ê¸°ë¡ í‘œì‹œ
            let analysisHtml = '';
            if (recentAnalyses && recentAnalyses.length > 0) {
                analysisHtml = '<div style="max-height: 200px; overflow-y: auto;">';
                recentAnalyses.forEach((analysis, index) => {
                    const analysisDate = new Date(analysis.analysis_date).toLocaleString();
                    const completionColor = analysis.overall_completion_rate >= 80 ? '#27ae60' : 
                                           analysis.overall_completion_rate >= 60 ? '#f39c12' : '#e74c3c';
                    
                    analysisHtml += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; ${index === 0 ? 'border-top: 1px solid #eee;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>${analysisDate}</strong></span>
                                <span style="color: ${completionColor}; font-weight: bold;">${analysis.overall_completion_rate}%</span>
                            </div>
                            <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;">
                                ì´ìˆ˜í•™ì : ${analysis.total_completed_credits}/${analysis.total_required_credits}
                            </div>
                        </div>
                    `;
                });
                analysisHtml += '</div>';
            } else {
                analysisHtml = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">ì•„ì§ ë¶„ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            document.getElementById('recentAnalysis').innerHTML = analysisHtml;
        }

        function editProfile() {
            // í˜„ì¬ í”„ë¡œí•„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const basicInfo = document.getElementById('basicInfo').querySelector('.profile-info');
            const academicInfo = document.getElementById('academicInfo').querySelector('.profile-info');

            // ìˆ˜ì • ê°€ëŠ¥í•œ í•„ë“œë§Œ ì„ íƒ
            const editableFields = ['phone', 'email'];
            
            // ìˆ˜ì • ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2 style="color: #2c3e50; margin-bottom: 25px;">âœï¸ ë‚´ ì •ë³´ ìˆ˜ì •</h2>
                    
                    <form id="profileEditForm" onsubmit="saveProfileChanges(event)" style="display: grid; gap: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label for="phone" style="display: block; margin-bottom: 5px;">ì „í™”ë²ˆí˜¸</label>
                                <input type="tel" id="phone" name="phone" 
                                       pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}" 
                                       placeholder="010-1234-5678"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="email" style="display: block; margin-bottom: 5px;">ì´ë©”ì¼</label>
                                <input type="email" id="email" name="email" 
                                       placeholder="example@example.com"
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn" style="background: #27ae60;">ì €ì¥</button>
                            <button type="button" onclick="this.closest('.modal').remove()" class="btn" style="background: #95a5a6; margin-left: 10px;">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // í˜„ì¬ ê°’ ì„¤ì •
            const phoneInput = document.getElementById('phone');
            const emailInput = document.getElementById('email');
            
            phoneInput.value = document.querySelector('[data-field="phone"]')?.textContent.trim() || '';
            emailInput.value = document.querySelector('[data-field="email"]')?.textContent.trim() || '';
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            };
        }

        async function saveProfileChanges(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                phone: formData.get('phone'),
                email: formData.get('email')
            };
            
            try {
                const response = await fetch('/api/student/profile/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    event.target.closest('.modal').remove();
                    loadProfileData(); // í”„ë¡œí•„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                } else {
                    showAlert(result.error || 'í”„ë¡œí•„ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showAlert('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeProfileModal();
            }
        });

        // ì•Œë¦¼ ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function loadNotifications() {
            try {
                // ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ ì¡°íšŒ
                const countResponse = await fetch('/api/student/notifications/unread-count');
                const countData = await countResponse.json();
                
                if (countData.success) {
                    updateNotificationBadge(countData.unread_count);
                }
                
                // ìµœê·¼ ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ (ë“œë¡­ë‹¤ìš´ìš©)
                const notificationsResponse = await fetch('/api/student/notifications?limit=5');
                const notificationsData = await notificationsResponse.json();
                
                if (notificationsData.success) {
                    updateNotificationDropdown(notificationsData.notifications);
                }
            } catch (error) {
                console.error('ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateNotificationDropdown(notifications) {
            const container = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="notification-empty">
                        <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“­</div>
                        <div>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            notifications.forEach(notification => {
                const isUnread = !notification.is_read;
                const isUrgent = notification.is_urgent;
                const sentTime = new Date(notification.sent_at).toLocaleString();
                const timeAgo = getTimeAgo(new Date(notification.sent_at));
                
                html += `
                    <div class="notification-item ${isUnread ? 'unread' : ''} ${isUrgent ? 'urgent' : ''}" 
                         onclick="markNotificationAsRead(${notification.id})">
                        <div class="notification-title">
                            ${isUrgent ? 'ğŸš¨ ' : ''}${notification.title}
                            ${isUnread ? '<span style="color: #667eea; font-size: 0.8em; margin-left: 5px;">â—</span>' : ''}
                        </div>
                        <div class="notification-message">
                            ${notification.message.length > 100 ? 
                              notification.message.substring(0, 100) + '...' : 
                              notification.message}
                        </div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notificationDropdown');
            const isVisible = dropdown.style.display === 'block';
            
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                dropdown.style.display = 'block';
                loadNotifications(); // ë“œë¡­ë‹¤ìš´ì„ ì—´ ë•Œ ìµœì‹  ì•Œë¦¼ ë¡œë“œ
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/student/notifications/${notificationId}/read`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ì•Œë¦¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadNotifications();
                } else {
                    console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', data.error);
                }
            } catch (error) {
                console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
        }

        async function markAllNotificationsRead() {
            try {
                const response = await fetch('/api/student/notifications/mark-all-read', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ì•Œë¦¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadNotifications();
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.error || 'ì•Œë¦¼ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('ì „ì²´ ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showAlert('ì•Œë¦¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function showAllNotifications() {
            // ì•Œë¦¼ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2 style="color: #2c3e50; margin-bottom: 25px;">ğŸ“¢ ì „ì²´ ì•Œë¦¼ ëª©ë¡</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <button onclick="loadAllNotifications('all')" class="btn" style="margin-right: 10px;">ì „ì²´</button>
                        <button onclick="loadAllNotifications('unread')" class="btn" style="background: #e74c3c;">ì½ì§€ ì•ŠìŒ</button>
                        <button onclick="markAllNotificationsRead()" class="btn" style="background: #27ae60; margin-left: 10px;">ëª¨ë‘ ì½ìŒ ì²˜ë¦¬</button>
                    </div>
                    
                    <div id="allNotificationsList" style="max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                            ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ì „ì²´ ì•Œë¦¼ ë¡œë“œ
            loadAllNotifications('all');
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            };
            
            // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.getElementById('notificationDropdown').style.display = 'none';
        }

        async function loadAllNotifications(filter = 'all') {
            try {
                const unreadOnly = filter === 'unread';
                const response = await fetch(`/api/student/notifications?unread_only=${unreadOnly}&limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    displayAllNotifications(data.notifications);
                } else {
                    document.getElementById('allNotificationsList').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e74c3c;">
                            ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ì „ì²´ ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('allNotificationsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        function displayAllNotifications(notifications) {
            const container = document.getElementById('allNotificationsList');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“­</div>
                        <div>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            notifications.forEach(notification => {
                const isUnread = !notification.is_read;
                const isUrgent = notification.is_urgent;
                const sentTime = new Date(notification.sent_at).toLocaleString();
                
                html += `
                    <div class="notification-item ${isUnread ? 'unread' : ''} ${isUrgent ? 'urgent' : ''}" 
                         onclick="markNotificationAsRead(${notification.id})"
                         style="margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee;">
                        <div class="notification-title">
                            ${isUrgent ? 'ğŸš¨ ' : ''}${notification.title}
                            ${isUnread ? '<span style="color: #667eea; font-size: 0.8em; margin-left: 5px;">â— ìƒˆ ì•Œë¦¼</span>' : ''}
                        </div>
                        <div class="notification-message" style="white-space: pre-wrap; margin: 10px 0;">
                            ${notification.message}
                        </div>
                        <div class="notification-time">
                            ğŸ“… ${sentTime}
                            ${notification.read_at ? ` â€¢ ì½ìŒ: ${new Date(notification.read_at).toLocaleString()}` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'ë°©ê¸ˆ ì „';
            } else if (diffInSeconds < 3600) {
                return `${Math.floor(diffInSeconds / 60)}ë¶„ ì „`;
            } else if (diffInSeconds < 86400) {
                return `${Math.floor(diffInSeconds / 3600)}ì‹œê°„ ì „`;
            } else if (diffInSeconds < 2592000) {
                return `${Math.floor(diffInSeconds / 86400)}ì¼ ì „`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // ì™¸ë¶€ í´ë¦­ ì‹œ ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const notificationIcon = document.querySelector('.notification-icon');
            const dropdown = document.getElementById('notificationDropdown');
            
            if (!notificationIcon.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
    </script>
</body>
</html>